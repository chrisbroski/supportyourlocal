<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title></title>
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bowlby+One+SC&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/inc/main.css">

<body>

<!--#include file="/api/header.pht" -->

<main id="home">
<article></article>
</main>

<script type="text/javascript" src="/inc/Aerophane.js"></script>
<script type="text/javascript" src="/inc/main.js"></script>
<script type="text/javascript" src="/inc/showdown.min.js"></script>
<script>
var converter = new showdown.Converter();

function embedSpotifyPlayer(id, type) {
    var iframe = document.createElement("iframe");
    iframe.className = "spotify-player-sm";
    iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
    iframe.src = `https://open.spotify.com/embed/${type}/${id}`;
    return iframe;
}

function showAnnouncements(announcementData) {
    var marquee = document.querySelector("main#home article:first-child");

    announcementData.announcements.forEach(function (a, idx) {
        var announcement = document.createElement("div");
        var p;

        announcement.innerHTML = converter.makeHtml(a.copy);

        if (a.spotifyTrackId) {
            p = document.createElement("p");
            p.appendChild(embedSpotifyPlayer(a.spotifyTrackId, "track"));
            announcement.appendChild(p);
        }
        marquee.appendChild(announcement);
    });
}

function showBandInfo(info) {
    var article;
    var section;
    var more;
    var h1;
    // var div;
    document.title = info.name;
    h1 = document.createElement("h1");
    h1.textContent = info.name;
    document.querySelector("main#home > article:first-child").appendChild(h1);

    if (info.bio) {
        article = document.createElement("article");
        article.id = "about";
        section = document.createElement("section");
        section.innerHTML = converter.makeHtml(info.bio);
        more = document.createElement("a");
        more.className = "more";
        more.href = "/about";
        more.textContent = "Moreâ€¦";
        h1 = document.createElement("h1");
        h1.textContent = "About";
        section.insertBefore(h1, section.firstChild);
        // div = document.createElement("div");
        // div.className = "fade-out";
        // section.appendChild(div);
        article.appendChild(section);
        article.appendChild(more);
        document.querySelector("main").appendChild(article);
    }
}

function showShows(info) {
    var article;
    var section;
    var more;
    var h1;
    var infoDiv;

    if (info.gigs.length > 0) {
        article = document.createElement("article");
        article.id = "shows";
        section = document.createElement("section");
        section.className = "col2";
        h1 = document.createElement("h1");
        h1.textContent = "Next Show";
        section.appendChild(h1);
        infoDiv = gigInfoDiv(info.gigs[0])

        if (info.gigs.length > 1) {
            more = document.createElement("a");
            more.className = "more";
            more.href = "/shows";
            more.textContent = "More Shows";
            infoDiv.appendChild(more);
        }

        section.appendChild(infoDiv);
        section.appendChild(gigMapDiv(info.gigs[0]));
        article.appendChild(section);

        // section.insertBefore(h1, section.firstChild);
        // article.appendChild(more);
        document.querySelector("main").appendChild(article);
    }
}

function showMusic(info) {
    var article;
    var section;
    var more;
    var h1;
    var infoDiv;
    var p;
    var img;

    if (info.length > 0) {
        article = document.createElement("article");
        article.id = "music";
        section = document.createElement("section");
        section.className = "col2";
        h1 = document.createElement("h1");
        h1.textContent = "Music";
        section.appendChild(h1);
        infoDiv = document.createElement("div");

        if (info[0].desc) {
            infoDiv.innerHTML = converter.makeHtml(info[0].desc);
        }
        var h1 = document.createElement("h3");
        h1.textContent = info[0].name;
        infoDiv.insertBefore(h1, infoDiv.firstChild);

        p = document.createElement("p");
        p.textContent = `Released ${info[0].date}`;
        infoDiv.appendChild(p);

        if (info[0].audio.spotify) {
            console.log('spotify found');
        }
        if (info[0].audio.spotify) {
            p = document.createElement("p");
            p.appendChild(embedSpotifyPlayer(extractSpotifyTrackId(info[0].audio.spotify), "track"));
            infoDiv.appendChild(p);
        }

        if (info.length > 1) {
            more = document.createElement("a");
            more.className = "more";
            more.href = "/song";
            more.textContent = "More Songs";
            infoDiv.appendChild(more);
        }

        section.appendChild(infoDiv);

        infoDiv = document.createElement("div");
        if (info[0]["cover-front"]) {
            img = document.createElement("img");
            img.src = info[0]["cover-front"];
            infoDiv.appendChild(img);
        }
        section.appendChild(infoDiv);
        article.appendChild(section);
        document.querySelector("main").appendChild(article);
    }
}

function getAnnouncements() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/api/announcement/?pinned=Y");
    xhr.setRequestHeader("Accept", "application/json");
    xhr.addEventListener("load", function () {
        showAnnouncements(JSON.parse(this.responseText));
    });
    xhr.send();
}

function getHomeInfo() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/api/home/");
    xhr.setRequestHeader("Accept", "application/json");
    xhr.addEventListener("load", function () {
        showBandInfo(JSON.parse(this.responseText));
    });
    xhr.send();
}

function getNextShow() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/api/gig/?range=upcoming");
    xhr.setRequestHeader("Accept", "application/json");
    xhr.addEventListener("load", function () {
        showShows(JSON.parse(this.responseText));
    });
    xhr.send();
}

function getLatestMusic() {
    var xhr = new XMLHttpRequest();
    // I'll need to check albums too. In the future....
    xhr.open("GET", "/api/song/");
    xhr.setRequestHeader("Accept", "application/json");
    xhr.addEventListener("load", function () {
        showMusic(JSON.parse(this.responseText));
    });
    xhr.send();
}

getHomeInfo();
getAnnouncements();
getNextShow();
getLatestMusic();
</script>
